{% comment %}
  Product Page Builder - App Proxy Version with Debug and Fallback
{% endcomment %}

{% schema %}
{
  "name": "Ring Builder Button",
  "target": "section",
  "enabled_on": {"templates": ["product"]},
  "settings": [
    {"type": "checkbox","id": "show_info_table","label": "Show product info table","default": true},
    {"type": "checkbox","id": "debug_mode","label": "Enable debug mode","default": false},
    {"type": "checkbox","id": "use_fallback","label": "Use fallback mode (bypass app proxy)","default": false},
    {"type": "text","id": "add_to_ring_text","label": "Add to Ring button text","default": "Add to Ring"},
    {"type": "text","id": "add_to_pendant_text","label": "Add to Pendant button text","default": "Add to Pendant"},
    {"type": "text","id": "setting_button_text","label": "Button text for settings","default": "Select a Gemstone ‚Üí"},
    {"type": "text","id": "add_both_text","label": "Button text when both selected","default": "Add Both to Cart"},
    {"type": "text","id": "gemstone_collection","label": "Gemstone collection handle","default": "loose-white-lab-grown-diamonds"},
    {"type": "text","id": "ring_settings_collection","label": "Ring Settings collection handle","default": "ring-settings"},
    {"type": "text","id": "pendant_settings_collection","label": "Pendant Settings collection handle","default": "pendant-settings"}
  ]
}
{% endschema %}

{%- liquid
  # Product classification (fallback logic)
  assign pt = product.type | downcase
  assign is_gem = false
  assign is_set = false
  assign is_preview = false
  
  if product.handle == 'custom-ring-preview'
    assign is_preview = true
  endif
  
  # Check if it's a diamond/gemstone (loose stone)
  if pt contains 'stone' or pt contains 'loose' or pt contains 'diamond'
    assign is_gem = true
  elsif product.tags contains 'gemstone' or product.tags contains 'Loose Stone' or product.tags contains 'loose stone'
    assign is_gem = true
  elsif product.tags contains 'White Lab Diamond' or product.tags contains 'Lab Diamond'
    assign is_gem = true
  endif

  # Check if it's a setting
  unless is_gem
    if pt contains 'ring' or pt contains 'pendant' or pt contains 'setting' or pt contains 'mount'
      assign is_set = true
    elsif product.tags contains 'Setting_Ring' or product.tags contains 'Setting_Pendant' or product.tags contains 'Ring Setting' or product.tags contains 'Pendant Setting'
      assign is_set = true
    endif
  endunless
  
  assign show = false
  if is_gem or is_set or is_preview
    assign show = true
  endif
  
  # Build query parameters for the app proxy
  assign query_params = 'product_handle=' | append: product.handle
  
  if block.settings.show_info_table != blank
    assign query_params = query_params | append: '&show_info_table=' | append: block.settings.show_info_table
  endif
  
  if block.settings.gemstone_button_text != blank
    assign encoded_text = block.settings.gemstone_button_text | url_encode
    assign query_params = query_params | append: '&gemstone_button_text=' | append: encoded_text
  endif
  
  if block.settings.setting_button_text != blank
    assign encoded_text = block.settings.setting_button_text | url_encode
    assign query_params = query_params | append: '&setting_button_text=' | append: encoded_text
  endif
  
  if block.settings.add_both_text != blank
    assign encoded_text = block.settings.add_both_text | url_encode
    assign query_params = query_params | append: '&add_both_text=' | append: encoded_text
  endif
  
  if block.settings.gemstone_collection != blank
    assign query_params = query_params | append: '&gemstone_collection=' | append: block.settings.gemstone_collection
  endif
  
  if block.settings.settings_collection != blank
    assign query_params = query_params | append: '&settings_collection=' | append: block.settings.settings_collection
  endif
  
  assign app_proxy_url = '/apps/nanogem-builder/product-builder?' | append: query_params
-%}

{%- if block.settings.debug_mode -%}
<div style="background: #fef3c7; border: 1px solid #f59e0b; padding: 15px; margin: 10px 0; border-radius: 6px; font-family: monospace; font-size: 12px;">
  <strong>üîç Product Builder Debug Info:</strong><br>
  Product Type: <code>{{ product.type }}</code><br>
  Product Tags: <code>{{ product.tags | join: ', ' }}</code><br>
  Product Handle: <code>{{ product.handle }}</code><br>
  Is Gemstone: <code>{{ is_gem }}</code><br>
  Is Setting: <code>{{ is_set }}</code><br>
  Should Show: <code>{{ show }}</code><br>
  App Proxy URL: <code>{{ app_proxy_url | truncate: 100 }}</code>
</div>
{%- endif -%}

{%- if show -%}
  {%- if block.settings.use_fallback -%}
    <!-- FALLBACK MODE: Direct button without app proxy -->
    <div class="rb-wrap">
      {%- if is_gem or is_set -%}
        {%- assign url_gemstone = '' -%}
        {%- assign url_setting = '' -%}
        {%- for param in request.url.params -%}
          {%- if param[0] == 'gemstone' -%}{%- assign url_gemstone = param[1] -%}{%- endif -%}
          {%- if param[0] == 'setting' -%}{%- assign url_setting = param[1] -%}{%- endif -%}
        {%- endfor -%}
        
        {%- assign has_both = false -%}
        {%- if is_gem and url_setting != blank -%}{%- assign has_both = true -%}{%- endif -%}
        {%- if is_set and url_gemstone != blank -%}{%- assign has_both = true -%}{%- endif -%}
        
        {%- if has_both -%}
          <div class="rb-selected" style="background:#f0f9ff;border:1px solid #bae6fd;border-radius:6px;padding:10px 14px;margin-bottom:12px;font-size:13px;color:#0369a1;">
            <strong>Selected {% if is_gem %}setting{% else %}gemstone{% endif %}:</strong>
            {% if is_gem %}{{ url_setting | replace: '-', ' ' }}{% else %}{{ url_gemstone | replace: '-', ' ' }}{% endif %}
          </div>
          <button type="button"
                  class="button button--full-width"
                  onclick="handleRingBuilderClick('both')"
                  style="margin-top: 10px;">
            {{ block.settings.add_both_text }}
          </button>
        {%- elsif is_gem -%}
          <style>.rb-btn{flex:1;padding:12px 20px;border:1px solid #222;background:#fff;color:#222;cursor:pointer;font-weight:500;text-transform:uppercase;transition:all .2s}.rb-btn:hover{background:#A7C9D9;border-color:#A7C9D9}.rb-cart{width:100%;padding:12px 20px;border:1px solid #222;background:#fff;color:#222;cursor:pointer;font-weight:500;text-transform:uppercase;margin-top:10px;transition:all .2s}.rb-cart:hover{background:#000;color:#fff;border-color:#000}</style>
          <div style="display:flex;gap:10px;margin-top:10px;">
            <button type="button" class="rb-btn" onclick="handleRingBuilderClick('ring')">{{ block.settings.add_to_ring_text }}</button>
            <button type="button" class="rb-btn" onclick="handleRingBuilderClick('pendant')">{{ block.settings.add_to_pendant_text }}</button>
          </div>
          <button type="button" class="rb-cart" onclick="addGemstoneToCart()">Add to Cart</button>
        {%- else -%}
          <button type="button"
                  class="button button--full-width"
                  onclick="handleRingBuilderClick('gemstone')"
                  style="margin-top: 10px;">
            {{ block.settings.setting_button_text }}
          </button>
        {%- endif -%}
        <script>
        function handleRingBuilderClick(mode) {
          // mode can be: 'ring', 'pendant', 'gemstone', or 'both'
          const debugMode = {{ block.settings.debug_mode | default: false | json }};

          const isGem = {{ is_gem | json }};
          const isBoth = {{ has_both | json }};
          const handle = '{{ product.handle }}';

          // Collection handles from settings
          const ringCollection = '{{ block.settings.ring_settings_collection }}';
          const pendantCollection = '{{ block.settings.pendant_settings_collection }}';
          const gemstoneCollection = '{{ block.settings.gemstone_collection }}';

          // Function to show debug and wait
          function showDebugAndWait(debugInfo, finalUrl) {
            let debugDiv = document.getElementById('rb-debug');
            if (!debugDiv) {
              debugDiv = document.createElement('div');
              debugDiv.id = 'rb-debug';
              debugDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: #000;
                color: #0f0;
                padding: 20px;
                border: 2px solid #0f0;
                border-radius: 5px;
                font-family: monospace;
                font-size: 12px;
                max-width: 600px;
                max-height: 80vh;
                overflow-y: auto;
                z-index: 99999;
                box-shadow: 0 0 20px rgba(0,255,0,0.3);
              `;
              document.body.appendChild(debugDiv);
            }

            debugDiv.innerHTML = debugInfo;

            // Add buttons
            const buttonDiv = document.createElement('div');
            buttonDiv.style.marginTop = '15px';

            const continueBtn = document.createElement('button');
            continueBtn.textContent = 'CONTINUE ‚Üí';
            continueBtn.style.cssText = `
              padding: 8px 16px;
              background: #0f0;
              color: #000;
              border: none;
              cursor: pointer;
              font-weight: bold;
              margin-right: 10px;
            `;
            continueBtn.onclick = () => {
              window.location.href = finalUrl;
            };

            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'CANCEL';
            closeBtn.style.cssText = `
              padding: 8px 16px;
              background: #f00;
              color: #fff;
              border: none;
              cursor: pointer;
            `;
            closeBtn.onclick = () => {
              debugDiv.remove();
            };

            buttonDiv.appendChild(continueBtn);
            buttonDiv.appendChild(closeBtn);
            debugDiv.appendChild(buttonDiv);
          }

          // Start building debug info
          let debugInfo = '<strong>üêõ RING BUILDER DEBUG</strong><br>';
          debugInfo += `Time: ${new Date().toLocaleTimeString()}<br>`;
          debugInfo += `Current URL: ${window.location.href}<br>`;
          debugInfo += `Mode: ${mode}<br>`;
          debugInfo += `Is Gem: ${isGem}<br>`;
          debugInfo += `Has Both: ${isBoth}<br>`;
          debugInfo += '<hr style="margin:5px 0;border-color:#0f0">';

          // Get FRESH params at click time
          const currentParams = new URLSearchParams(window.location.search);

          if (mode === 'both') {
            // Navigate to preview with both items
            const cleanParams = new URLSearchParams();

            debugInfo += 'MODE: Has Both - Going to Preview<br>';
            debugInfo += `Gemstone: ${currentParams.get('gemstone') || 'none'}<br>`;
            debugInfo += `Setting: ${currentParams.get('setting') || 'none'}<br>`;
            debugInfo += `Setting Variant: ${currentParams.get('setting_variant') || 'none'}<br>`;

            if (currentParams.get('gemstone')) cleanParams.set('gemstone', currentParams.get('gemstone'));
            if (currentParams.get('setting')) cleanParams.set('setting', currentParams.get('setting'));
            if (currentParams.get('setting_variant')) cleanParams.set('setting_variant', currentParams.get('setting_variant'));

            const previewUrl = '/products/custom-ring-preview?' + cleanParams.toString();
            debugInfo += `<br>REDIRECT TO: ${previewUrl}`;

            if (debugMode) {
              showDebugAndWait(debugInfo, previewUrl);
            } else {
              window.location.href = previewUrl;
            }

          } else if (mode === 'ring' || mode === 'pendant') {
            // Gemstone selected, navigating to ring or pendant settings
            const collection = mode === 'ring' ? ringCollection : pendantCollection;

            debugInfo += `MODE: Gemstone ‚Üí ${mode === 'ring' ? 'Ring' : 'Pendant'} Settings<br>`;
            debugInfo += `Product Handle: ${handle}<br>`;
            debugInfo += `Collection: ${collection}<br>`;
            debugInfo += '<hr style="margin:5px 0;border-color:#0f0">';

            // Get current variant
            let currentVariant = currentParams.get('variant');
            const formInput = document.querySelector('input[name="id"]');
            const radioInput = document.querySelector('[name="id"]:checked');
            const selectInput = document.querySelector('select[name="id"]');

            debugInfo += `<strong>CHECKING VARIANTS:</strong><br>`;
            debugInfo += `URL variant param: ${currentVariant || 'none'}<br>`;
            debugInfo += `Form input value: ${formInput?.value || 'not found'}<br>`;

            if (!currentVariant) {
              currentVariant = formInput?.value || radioInput?.value || selectInput?.value;
              debugInfo += `Using form variant: ${currentVariant || 'none'}<br>`;
            }

            debugInfo += `<strong style="color:#ff0">FINAL VARIANT: ${currentVariant || 'NONE!'}</strong><br>`;
            debugInfo += '<hr style="margin:5px 0;border-color:#0f0">';

            // Build URL with gemstone info
            const cleanParams = new URLSearchParams();
            cleanParams.set('gemstone', handle);

            if (currentVariant) {
              cleanParams.set('gemstone_variant', currentVariant);
              debugInfo += `Setting gemstone_variant: ${currentVariant}<br>`;
            }

            const finalUrl = `/collections/${collection}?${cleanParams.toString()}`;
            debugInfo += `<strong>FINAL URL:</strong><br>${finalUrl}`;

            if (debugMode) {
              showDebugAndWait(debugInfo, finalUrl);
            } else {
              window.location.href = finalUrl;
            }

          } else if (mode === 'gemstone') {
            // Setting selected, navigating to gemstone collection
            debugInfo += `MODE: Setting ‚Üí Gemstones<br>`;
            debugInfo += `Product Handle: ${handle}<br>`;
            debugInfo += `Collection: ${gemstoneCollection}<br>`;
            debugInfo += '<hr style="margin:5px 0;border-color:#0f0">';

            // Get current variant
            let currentVariant = currentParams.get('variant');
            const formInput = document.querySelector('input[name="id"]');
            const radioInput = document.querySelector('[name="id"]:checked');
            const selectInput = document.querySelector('select[name="id"]');

            debugInfo += `<strong>CHECKING VARIANTS:</strong><br>`;
            debugInfo += `URL variant param: ${currentVariant || 'none'}<br>`;

            if (!currentVariant) {
              currentVariant = formInput?.value || radioInput?.value || selectInput?.value;
              debugInfo += `Using form variant: ${currentVariant || 'none'}<br>`;
            }

            debugInfo += `<strong style="color:#ff0">FINAL VARIANT: ${currentVariant || 'NONE!'}</strong><br>`;
            debugInfo += '<hr style="margin:5px 0;border-color:#0f0">';

            // Build URL with setting info
            const cleanParams = new URLSearchParams();
            cleanParams.set('setting', handle);

            if (currentVariant) {
              cleanParams.set('setting_variant', currentVariant);
              debugInfo += `Setting setting_variant: ${currentVariant}<br>`;
            }

            // Preserve any existing gemstone selection
            if (currentParams.get('gemstone')) {
              cleanParams.set('gemstone', currentParams.get('gemstone'));
              debugInfo += `Preserving gemstone: ${currentParams.get('gemstone')}<br>`;
              if (currentParams.get('gemstone_variant')) {
                cleanParams.set('gemstone_variant', currentParams.get('gemstone_variant'));
              }
            }

            const finalUrl = `/collections/${gemstoneCollection}?${cleanParams.toString()}`;
            debugInfo += `<strong>FINAL URL:</strong><br>${finalUrl}`;

            if (debugMode) {
              showDebugAndWait(debugInfo, finalUrl);
            } else {
              window.location.href = finalUrl;
            }
          }
        }

        function addGemstoneToCart() {
          let v = new URLSearchParams(location.search).get('variant') || document.querySelector('input[name="id"]')?.value || '{{ product.selected_or_first_available_variant.id }}';
          fetch('/cart/add.js',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:v,quantity:1})})
          .then(r=>r.json()).then(()=>{
            const b=document.querySelector('.rb-cart');
            if(b){b.textContent='Added!';b.style.background='#22c55e';setTimeout(()=>{b.textContent='Add to Cart';b.style.background='#222'},2000)}
            document.dispatchEvent(new CustomEvent('cart:refresh'));
          }).catch(()=>alert('Error adding to cart'));
        }
        </script>
      {%- endif -%}
    </div>
  {%- else -%}
    <!-- APP PROXY MODE -->
    <div id="product-builder-{{ product.id }}" class="product-builder-container">
      <div style="text-align: center; padding: 10px;">
        <div class="loading-spinner" style="display: inline-block; width: 30px; height: 30px; border: 3px solid #f3f4f6; border-top-color: #3b82f6; border-radius: 50%; animation: pb-spin 1s linear infinite;"></div>
        <p style="color: #666; font-size: 14px; margin-top: 8px;">Loading custom jewelry options...</p>
      </div>
    </div>
    
    <style>
      @keyframes pb-spin {
        to { transform: rotate(360deg); }
      }
    </style>
    
    <script>
    (function() {
      const urlParams = new URLSearchParams(window.location.search);
      const appProxyBase = '{{ app_proxy_url }}';
      const appUrl = new URL(appProxyBase, window.location.origin);
      urlParams.forEach((value, key) => {
        if (!appUrl.searchParams.has(key)) appUrl.searchParams.append(key, value);
      });
      fetch(appUrl.toString())
        .then(response => {
          if (!response.ok) throw new Error(`Network response was not ok: ${response.status}`);
          return response.text();
        })
        .then(html => {
          const container = document.getElementById('product-builder-{{ product.id }}');
          if (container) {
            container.innerHTML = html;
            const scripts = container.querySelectorAll('script');
            scripts.forEach(oldScript => {
              const newScript = document.createElement('script');
              newScript.textContent = oldScript.textContent;
              document.body.appendChild(newScript);
              oldScript.remove();
            });
          }
        })
        .catch(error => {
          const container = document.getElementById('product-builder-{{ product.id }}');
          if (container) {
            container.innerHTML = `<div style="text-align: center; padding: 20px; background: #fee; border: 1px solid #fcc; border-radius: 6px; margin: 10px 0;"><p style="color: #c00; margin: 0 0 10px 0;">Unable to load product builder</p><p style="color: #666; font-size: 14px; margin: 0;">Please refresh the page or contact support if the problem persists.</p></div>`;
          }
        });
    })();
    </script>
  {%- endif -%}
{%- elsif block.settings.debug_mode -%}
  <div style="background: #fee; border: 1px solid #fcc; padding: 10px; margin: 10px 0; border-radius: 4px;">
    Product builder not showing because product is not classified as gemstone or setting.
  </div>
{%- endif -%}