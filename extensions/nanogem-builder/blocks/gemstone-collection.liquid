{% schema %}
{
  "name": "Ring Builder Collection",
  "target": "section",
  "enabled_on": {"templates": ["collection"]},
  "settings": [
    {"type": "checkbox","id": "show_steps_banner","label": "Show steps banner","default": true},
    {"type": "checkbox","id": "auto_detect","label": "Auto-detect ring builder collections","default": true},
    {"type": "text","id": "collection_handles","label": "Specific collection handles","placeholder": "gemstones,sapphires,ring-settings"},
    {"type": "text","id": "gemstone_collection_url","label": "Diamond collection URL","default": "/collections/loose-white-lab-grown-diamonds"},
    {"type": "text","id": "setting_collection_url","label": "Setting collection URL","default": "/collections/settings"},
    {"type": "checkbox","id": "show_filters","label": "Show filters","default": true},
    {"type": "range","id": "products_per_row_desktop","min": 2,"max": 5,"step": 1,"label": "Products per row (desktop)","default": 4},
    {"type": "select","id": "products_per_row_mobile","label": "Products per row (mobile)","options": [{"value": "1", "label": "1"}, {"value": "2", "label": "2"}],"default": "2"},
    {"type": "range","id": "products_per_page","min": 24,"max": 248,"step": 8,"label": "Products to load for filtering","default": 120,"info": "Total products to load. Display is fixed at 24 per page."}
  ]
}
{% endschema %}

{%- liquid
assign is_rb = false
assign ch = collection.handle | downcase

if block.settings.collection_handles != blank
  assign handles = block.settings.collection_handles | split: ','
  for h in handles
    assign clean_h = h | strip | downcase
    if ch == clean_h
      assign is_rb = true
      break
    endif
  endfor
endif

unless is_rb
  if block.settings.auto_detect
    case ch
      when 'gemstones','gemstone','stones','precious-stones','precious_stones','sapphires','rubies','emeralds','diamonds','loose-stones','loose-diamonds','white-lab-diamonds','lab-diamonds','loose-white-lab-grown-diamonds','loose-blue-lab-grown-diamonds','loose-pink-lab-grown-diamonds','loose-yellow-lab-grown-diamonds','setting','settings','ring-settings','ring_settings','pendant-settings','pendant_settings','mountings','rings','pendants'
        assign is_rb = true
    endcase
    unless is_rb
      assign gem_check = 'gemstone,sapphire,ruby,emerald,stone,diamond,loose,lab-grown,setting,mounting,ring,pendant'
      assign gem_words = gem_check | split: ','
      for word in gem_words
        if ch contains word
          assign is_rb = true
          break
        endif
      endfor
      unless is_rb
        if collection.title contains 'precious'
          assign is_rb = true
        endif
      endunless
    endunless
  endif
endunless
-%}

{%- if is_rb -%}
<style>
.rb-loading { 
  text-align: center; 
  padding: 40px; 
  color: #666; 
}
#ring-builder-container {
  min-height: 400px;
}

/* Hide ALL Prestige collection elements when ring builder is active */
/* Hide the main collection section */
body.rb-active .shopify-section--main-collection {
  display: none !important;
}

/* Also hide by specific classes */
body.rb-active .color-scheme:has(.collection) {
  display: none !important;
}

/* Hide the container that holds everything */
body.rb-active .container:has(.collection) {
  display: none !important;
}

/* Hide collection toolbar */
body.rb-active .collection-toolbar {
  display: none !important;
}

/* Hide facets elements */
body.rb-active facets-drawer,
body.rb-active .facets-drawer,
body.rb-active .facets-sidebar,
body.rb-active safe-sticky {
  display: none !important;
}

/* Hide product list and collection main */
body.rb-active .collection,
body.rb-active .collection__main,
body.rb-active product-list,
body.rb-active .product-list {
  display: none !important;
}

/* Hide empty states */
body.rb-active .empty-state {
  display: none !important;
}
</style>

<div id="ring-builder-container" 
     data-collection="{{ collection.handle }}"
     data-settings='{{ block.settings | json | escape }}'>
  
  <!-- Skeleton loading state -->
  <div class="rb-skeleton-container">
    <style>
      .rb-skeleton-container {
        display: grid;
        gap: 20px;
        margin-top: 2rem;
        grid-template-columns: repeat({{ block.settings.products_per_row_desktop }}, 1fr);
      }
      
      @media (max-width: 768px) {
        .rb-skeleton-container {
          grid-template-columns: repeat({{ block.settings.products_per_row_mobile }}, 1fr);
          gap: 12px;
        }
      }
      
      /* Hide skeletons when content is loaded */
      .rb-loaded .rb-skeleton-container {
        display: none;
      }
      
      .rb-skeleton-card {
        background: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        overflow: hidden;
        height: 450px;
        position: relative;
      }
      
      .rb-skeleton-image {
        width: 100%;
        aspect-ratio: 1/1;
        background: #f0f0f0;
      }
      
      .rb-skeleton-content {
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      
      .rb-skeleton-title {
        height: 24px;
        background: #f0f0f0;
        border-radius: 4px;
        width: 80%;
      }
      
      .rb-skeleton-price {
        height: 20px;
        background: #f0f0f0;
        border-radius: 4px;
        width: 40%;
        margin-top: auto;
      }
      
      @keyframes rbShimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(200%); }
      }
      
      .rb-skeleton-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent 0%,
          rgba(255, 255, 255, 0.3) 20%,
          rgba(255, 255, 255, 0.5) 50%,
          rgba(255, 255, 255, 0.3) 80%,
          transparent 100%
        );
        animation: rbShimmer 2s infinite;
        z-index: 1;
      }
      
      /* Wave effect per column */
      .rb-skeleton-card:nth-child(4n+1)::before { animation-delay: 0s; }
      .rb-skeleton-card:nth-child(4n+2)::before { animation-delay: 0.1s; }
      .rb-skeleton-card:nth-child(4n+3)::before { animation-delay: 0.2s; }
      .rb-skeleton-card:nth-child(4n+4)::before { animation-delay: 0.3s; }
    </style>
    
    {% for i in (1..12) %}
      <div class="rb-skeleton-card">
        <div class="rb-skeleton-image"></div>
        <div class="rb-skeleton-content">
          <div class="rb-skeleton-title"></div>
          <div class="rb-skeleton-price"></div>
        </div>
      </div>
    {% endfor %}
  </div>
  
  <!-- Real content will be inserted here -->
  <div class="rb-content"></div>
</div>

<script>
(function() {
  document.body.classList.add('rb-active');

  const hidePrestigeElements = () => {
    ['.shopify-section--main-collection','[class*="main-collection"]','section[id*="main-collection"]'].forEach(s => {
      document.querySelectorAll(s).forEach(el => {
        el.style.setProperty('display', 'none', 'important');
        el.style.setProperty('visibility', 'hidden', 'important');
      });
    });
    ['.collection-toolbar','facets-drawer','.facets-drawer','.facets-sidebar','safe-sticky','.collection','.collection__main','product-list','.product-list','.empty-state','.color-scheme:has(.collection)','.container:has(.collection)'].forEach(s => {
      try {
        document.querySelectorAll(s).forEach(el => {
          el.style.setProperty('display', 'none', 'important');
          el.style.setProperty('visibility', 'hidden', 'important');
          el.style.setProperty('opacity', '0', 'important');
          el.style.setProperty('height', '0', 'important');
          el.style.setProperty('overflow', 'hidden', 'important');
        });
      } catch(e) {}
    });
  };

  hidePrestigeElements();
  setTimeout(hidePrestigeElements, 100);

  const container = document.getElementById('ring-builder-container');
  if (!container) return;

  const currentCurrency = window.Shopify?.currency?.active || window.Shopify?.currency?.current || document.querySelector('[name="currency"]')?.value || document.querySelector('.currency-selector__value')?.textContent?.trim() || 'USD';

  const params = new URLSearchParams({
    collection: container.dataset.collection,
    settings: container.dataset.settings,
    gemstone: new URLSearchParams(location.search).get('gemstone') || '',
    setting: new URLSearchParams(location.search).get('setting') || '',
    setting_variant: new URLSearchParams(location.search).get('setting_variant') || '',
    currency: currentCurrency
  });

  fetch('/apps/nanogem-builder/ring-builder?' + params)
    .then(response => {
      if (!response.ok) throw new Error('Network response was not ok');
      return response.text();
    })
    .then(html => {
      const contentDiv = container.querySelector('.rb-content');
      if (contentDiv) contentDiv.innerHTML = html;
      else container.innerHTML = html;

      container.classList.add('rb-loaded');
      document.body.classList.add('rb-active');
      hidePrestigeElements();

      const scripts = container.querySelectorAll('script');
      scripts.forEach(script => {
        const newScript = document.createElement('script');
        newScript.textContent = script.textContent;
        document.body.appendChild(newScript);
      });

      setTimeout(() => {
        if (window.RBA && window.RBA.init) {
          window.RBA.init();
          hidePrestigeElements();
        }
      }, 200);
    })
    .catch(error => {
      container.classList.add('rb-loaded');
      const contentDiv = container.querySelector('.rb-content');
      if (contentDiv) contentDiv.innerHTML = '<div style="text-align:center;padding:40px;color:#999;">Error loading ring builder. Please refresh the page.</div>';
      else container.innerHTML = '<div style="text-align:center;padding:40px;color:#999;">Error loading ring builder. Please refresh the page.</div>';
    });

  document.addEventListener('currency:changed', function(event) {
    const container = document.getElementById('ring-builder-container');
    if (container && container.classList.contains('rb-loaded')) location.reload();
  });

  const currencyForm = document.querySelector('form[action="/cart/update"]');
  if (currencyForm) {
    const currencySelector = currencyForm.querySelector('[name="currency"]');
    if (currencySelector) {
      currencySelector.addEventListener('change', function() {
        location.reload();
      });
    }
  }

})();  // <-- CLOSING OF THE MAIN FUNCTION
</script>
{%- endif -%}